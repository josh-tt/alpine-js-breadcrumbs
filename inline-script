<script>
    document.addEventListener('alpine:init', () => {
    Alpine.data('breadcrumb', ( link = 'http://something.com/dogs/cats/some-bird/some-otter?mvp=never', replacements = [ { find: 'dogs', replace: 'elephants', path: '' } ], bypass = [ '' ], icon = null ) => ({
        disabled: false,
	href: link,
	home: true,
	allowOneItem: false, // show the breadcrumb even if there is only one item
	back: false, // replace the first item with 'back' text
	referrerUrl: false, // use the window referrer url as the back url
	last: true, // show last item
	lettercase: 'lowercase', // uppercase, lowercase, capitalize
	title: false, // use document title as last item
	stripDashes: false,
	stripUnderscores: false,
	trailingSlash: false,
	bypassUrls: [
		...bypass,
		'http://something.com/dogs',
		'http://something.com/dogs/cats/',
		'http://something.com/dogs/cats/some-bird/some-otter?mvp=never',
	],
	stringReplace: true,
	stringReplacements: [
		...replacements,
		{
			find: 'bird',
			replace: 'birdie',
			path: '/dogs/cats/some-bird',
			pattern: '',
		},
		{
			find: 'some-otter',
			replace: 'otters',
			path: '',
			pattern: '',
		},
	],
	showFirstOnly: false, // only show the first item
	showPreviousOnly: false, // only show the previous item
	svg: 'home',
	homeSvg: '<svg home xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M8 0L0 8l1.414 1.414L8 2.828l5.586 5.586L16 8z"/></svg>',
	backSvg: '<svg back xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M8 0L0 8l1.414 1.414L8 2.828l5.586 5.586L16 8z"/></svg>',
	altSvg: icon || '<svg alt xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M8 0L0 8l1.414 1.414L8 2.828l5.586 5.586L16 8z"/></svg>',

	get url() {
		const href = this.href ? this.href : window.location.href;
		console.log( href );

		return href;
	},

	get urlObj() {
		const obj = new URL( this.url );
		const pathname = obj.pathname;
		const domain = obj.hostname;
		const search = obj.search;
		const searchParms = obj.searchParams;
		const hash = obj.hash;

		return {
			pathname,
			domain,
			search,
			searchParms,
			hash,
		};
	},

	get breadcrumbs() {
		if ( ! this.disabled ) {
			const pathname = this.urlObj.pathname;
			const crumbs = this.createBreadcrumbs( pathname ).filter( ( item ) => item.name !== '' );
			return crumbs;
		}

		return [];
	},

	get queryCrumbs() {
		if ( ! this.disabled ) {
			const search = this.urlObj.search;
			const searchParms = this.urlObj.searchParms;
			const queryCrumbs = this.createQueryCrumbs( search, searchParms );
			return queryCrumbs;
		}

		return [];
	},

	get hashCrumb() {
		if ( ! this.disabled ) {
			const hash = this.urlObj.hash;
			const hashCrumb = this.createHashCrumb( hash );
			return hashCrumb;
		}

		return [];
	},

	maybeDisable( url ) {
		if ( this.bypassUrls.includes( url ) ) {
			return this.disabled = true;
		}
		return this.disabled = false;
	},

	createBreadcrumbs( path ) {
		// Return home if path === '/'
		if ( path === '/' ) {
			return [ {
				name: 'Home',
				path: '/',
			} ];
		}

		let crumbs = [];

		// Split the path into an array of strings
		crumbs = path.split( '/' );
		crumbs = crumbs.map( ( breadcrumb, index ) => {
			// Replace the first item in the array with Home and the path with /
			if ( index === 0 ) {
				breadcrumb = 'Home';
				return {
					name: breadcrumb,
					path: '/',
				};
			}

			// If count is greater than 1, add the previous breadcrumb to the path
			return {
				name: breadcrumb,
				path: crumbs.slice( 0, index + 1 ).join( '/' ),
			};
		} );

		// Handle home, back and last options
		this.handleHome( crumbs );
		this.handleBack( crumbs );
		this.handleLast( crumbs );
		// Handle symbols and casings
		this.handleDashes( crumbs );
		this.handleUnderscores( crumbs );
		this.handleTrailingSlash( crumbs );
		this.handleLetterCase( crumbs );
		this.handleStringReplace( crumbs );
		// Remove items
		this.handleFirstOnly( crumbs );
		this.handlePreviousOnly( crumbs );
		this.handleSvg( crumbs );

		return crumbs;
	},

	createQueryCrumbs( search, searchParms ) {
		if ( search === '' ) {
			return [];
		}
		const queryCrumbs = [];
		searchParms.forEach( ( value, key ) => {
			queryCrumbs.push( {
				name: key,
				value,
			} );
		} );

		// Handle symbols and casings
		this.handleDashes( queryCrumbs );
		this.handleUnderscores( queryCrumbs );
		this.handleLetterCase( queryCrumbs );
		// Todo: handle string replace

		return queryCrumbs;
	},

	createHashCrumb( hash ) {
		if ( hash === '' ) {
			return [];
		}
		const hashCrumb = [ {
			name: hash.replace( '#', '' ),
			path: hash,
		} ];

		// Handle symbols and casings
		this.handleDashes( hashCrumb );
		this.handleUnderscores( hashCrumb );
		this.handleLetterCase( hashCrumb );
		// Todo: handle string replace

		return hashCrumb;
	},

	handleSvg( crumbs ) {
		if ( this.svg === 'home' ) {
			crumbs[ 0 ].svg = this.homeSvg;
		} else if ( this.svg === 'back' ) {
			crumbs[ 1 ].svg = this.backSvg;
		} else if ( this.svg === 'alt' ) {
			crumbs[ crumbs.length - 1 ].svg = this.altSvg;
		} else if ( this.svg === '' ) {
			crumbs[ 0 ].svg = '';
		}
	},

	handleHome( crumbs ) {
		if ( ! this.home ) {
			if ( crumbs[ 0 ].path === '/' ) {
				// Remove it from array
				crumbs.shift();
			}
		}
	},

	handleBack( crumbs ) {
		// If back is true, replace first item with 'back' text
		if ( this.back ) {
			crumbs[ 0 ].name = 'Back';
		}
		if ( this.referrerUrl ) {
			// Check if referrer is for this domain, if it is, use it
			if ( document.referrer.includes( this.urlObj.domain ) ) {
				crumbs[ 0 ].path = document.referrer;
			}
		}
	},

	handleFirstOnly( crumbs ) {
		if ( this.showFirstOnly ) {
			crumbs.length = 1;
		}
	},

	handlePreviousOnly( crumbs ) {
		if ( this.showPreviousOnly ) {
			// Get the second to last item in array and remove everything else
			const lastItem = crumbs[ crumbs.length - 2 ];
			if ( lastItem ) {
				crumbs.length = 0;
				crumbs.push( lastItem );
			}
		}
	},

	handleLast( crumbs ) {
		// If last is false, remove last item
		if ( ! this.last ) {
			crumbs.pop();
		}
		if ( this.last ) {
			// Use the document title
			if ( this.useTitle ) {
				crumbs[ crumbs.length - 1 ].name = document.title;
			}
		}
	},

	handleTrailingSlash( crumbs ) {
		if ( this.trailingSlash ) {
			// Add trailing slash to each crumb
			crumbs.map( ( crumb ) => {
				if ( ! crumb.path.endsWith( '/' ) ) {
					crumb.path = `${ crumb.path }/`;
				}
			} );
			return;
		}
		// If path is not equal to '/', remove trailing slash
		crumbs.map( ( crumb ) => {
			if ( crumb.path !== '/' && crumb.path.endsWith( '/' ) ) {
				crumb.path = crumb.path.slice( 0, -1 );
			}
		} );
	},

	handleLetterCase( crumbs ) {
		if ( this.lettercase === 'lowercase' ) {
			crumbs.map( ( crumb ) => {
				crumb.name = crumb.name.toLowerCase();
			} );
			return;
		}
		if ( this.lettercase === 'uppercase' ) {
			crumbs.map( ( crumb ) => {
				crumb.name = crumb.name.toUpperCase();
			} );
			return;
		}
		if ( this.lettercase === 'capitalize' ) {
			crumbs.map( ( crumb ) => {
				crumb.name = crumb.name.charAt( 0 ).toUpperCase() + crumb.name.slice( 1 );
			} );
		}
	},

	handleDashes( crumbs ) {
		if ( this.stripDashes ) {
			crumbs.map( ( crumb ) => {
				crumb.name = crumb.name.replace( /-/g, ' ' );
			} );
		}
	},

	handleUnderscores( crumbs ) {
		if ( this.stripUnderscores ) {
			crumbs.map( ( crumb ) => {
				crumb.name = crumb.name.replace( /_/g, ' ' );
			} );
		}
	},

	handleStringReplace( crumbs ) {
		if ( this.stringReplace ) {
			crumbs.map( ( crumb ) => {
				this.stringReplacements.forEach( ( replace ) => {
					// If path is not empty and path matches, do the find replace
					if ( replace.path !== '' ) {
						if ( crumb.path === replace.path ) {
							// If find is empty, replace the crumb name with replace name
							if ( replace.find === '' ) {
								crumb.name = replace.replace;
							} else {
							// If find is not empty, do the find replace
								crumb.name = crumb.name.replace( replace.find, replace.replace );
							}
						}
					} else if ( replace.path === '' ) {
						crumb.name = crumb.name.replace( replace.find, replace.replace );
					}
				} );
			} );
		}
	},

	init() {
		this.maybeDisable( this.href );
	},
    }))
})
</script>
